= Troubleshooting Guide
:toc:
:toc-placement!:

This guide helps you resolve common issues when setting up and using the Incident Management platform.

toc::[]

== Prerequisites and Setup

=== Verify Prerequisites

Run the prerequisites check:

[source,bash]
----
make check-prereqs
----

=== Common Setup Issues

==== Issue: Snowflake CLI Not Found

*Symptoms:*

----
-bash: snow: command not found
----

*Solution:*

. Install Snowflake CLI following the link:https://docs.snowflake.com/en/developer-guide/snowflake-cli/installation/installation[official guide]
. Verify installation:
+
[source,bash]
----
snow --version
----

==== Issue: Missing Environment Variables

*Symptoms:*

----
Error: Required environment variable not set
----

*Solution:*

. Verify `.env` file exists in project root
. Check that all required variables are set:
+
[source,bash]
----
cat .env | grep -v '^#' | grep -v '^$'
----
+
. Source the environment file:
+
[source,bash]
----
source .env
----

==== Issue: Invalid Connection Configuration

*Symptoms:*

----
Error: Connection '<name>' not found
----

*Solution:*

. Check your `~/.snowflake/config.toml` file exists
. Verify connection configuration:
+
[source,bash]
----
cat ~/.snowflake/config.toml
----
+
. Ensure connection name matches what you're using in commands

== Connection Issues

=== Cannot Connect to Snowflake

*Symptoms:*

* Connection timeout errors
* Authentication failures
* "Account not found" errors

*Diagnostics:*

. *Verify Account Name:*
+
[source,bash]
----
# Should be in format: <account>.<region>
# Example: xy12345.us-east-1
----

. *Test Connection:*
+
[source,bash]
----
snow connection test --connection <your-connection-name>
----

. *Check Network:*
+
[source,bash]
----
ping <your-account>.snowflakecomputing.com
----

*Solutions:*

* *Issue:* Wrong account identifier
  ** *Fix:* Update `~/.snowflake/config.toml` with correct account locator

* *Issue:* Network/Firewall blocking
  ** *Fix:* Contact your network administrator to allow Snowflake connections

* *Issue:* Expired credentials
  ** *Fix:* Re-authenticate or regenerate tokens

=== ACCOUNTADMIN Privileges Required

*Symptoms:*

----
Insufficient privileges to operate on account
----

*Solution:*

. Ask your Snowflake administrator for ACCOUNTADMIN role
. Or request they run the setup scripts on your behalf
. Verify your role:
+
[source,sql]
----
SELECT CURRENT_ROLE();
----

== Slack Connector Issues

=== Slack Messages Not Appearing in Snowflake

*Symptoms:*

* Messages posted in Slack don't appear in `SLACK_MESSAGES` table
* Table exists but is empty

*Diagnostics:*

. *Check Connector Status:*
   ** Navigate to OpenFlow runtime in Snowsight
   ** Verify connector shows as "Running"

. *Verify Table Exists:*
+
[source,sql]
----
SHOW TABLES LIKE 'SLACK_MESSAGES' IN SCHEMA bronze_zone;
----

. *Check for Errors:*
   ** Review OpenFlow runtime logs
   ** Look for connection errors or permission issues

*Solutions:*

* *Issue:* Slack app not installed in channel
  ** *Fix:* Add your Slack app to the channel:
+
----
/invite @YourIncidentBot
----

* *Issue:* Wrong channel configured
  ** *Fix:* Verify channel ID in OpenFlow connector configuration

* *Issue:* Insufficient Slack permissions
  ** *Fix:* Ensure app has required scopes:
    *** `channels:history`
    *** `channels:read`
    *** `files:read`
    *** `users:read`

* *Issue:* External access not configured
  ** *Fix:* Update External Access Integration:
+
[source,sql]
----
-- Verify slack.com is allowed
SHOW EXTERNAL ACCESS INTEGRATIONS;
----

=== Slack Attachments Not Processing

*Symptoms:*

* Text messages work but images don't appear
* `attachment_file` column is NULL

*Solutions:*

. *Check file permissions:*
+
[source,sql]
----
SELECT file_url, attachment_file, error 
FROM SLACK_MESSAGES 
WHERE file_url IS NOT NULL;
----

. *Verify Slack app has `files:read` scope*

. *Check External Access Integration includes Slack file domains:*
   ** `files.slack.com`
   ** `slack-files.com`

=== Duplicate Messages

*Symptoms:*

* Same message appears multiple times in `SLACK_MESSAGES`

*Solution:*

This is handled by the `v_qualify_slack_messages` model using window functions. Ensure you're querying the view, not the raw table:

[source,sql]
----
-- Use this (deduplicated)
SELECT * FROM bronze_zone.v_qualify_slack_messages;

-- Not this (may have duplicates)
SELECT * FROM bronze_zone.slack_messages;
----

== dbt Project Issues

=== dbt Deployment Fails

*Symptoms:*

----
Error deploying dbt project
----

*Diagnostics:*

. *Check dbt project structure:*
+
[source,bash]
----
cd src/incident_management
ls -la dbt_project.yml
----

. *Verify profiles.yml:*
+
[source,bash]
----
cat src/incident_management/profiles.yml
----

. *Test Snowflake connection:*
+
[source,bash]
----
snow connection test
----

*Solutions:*

* *Issue:* Missing or invalid `dbt_project.yml`
  ** *Fix:* Ensure file exists and is valid YAML
  ** *Fix:* Verify project name matches configuration

* *Issue:* Wrong database/schema names
  ** *Fix:* Update environment variables to match your setup
  ** *Fix:* Update `profiles.yml` accordingly

=== dbt Run Fails

*Symptoms:*

----
Compilation error
SQL execution error
----

*Diagnostics:*

. *Check dbt logs:*
+
[source,bash]
----
cat src/incident_management/logs/dbt.log
----

. *Run with debug flag:*
+
[source,bash]
----
snow dbt run --debug
----

. *Validate individual model:*
+
[source,bash]
----
snow dbt run --select incidents --debug
----

*Solutions:*

* *Issue:* Source table doesn't exist
  ** *Fix:* Verify Slack connector created required tables
  ** *Fix:* Run setup scripts in correct order

* *Issue:* Missing AI functions
  ** *Fix:* Ensure you're using Snowflake Enterprise or higher
  ** *Fix:* Verify Cortex AI is enabled in your region

* *Issue:* Compilation error in SQL
  ** *Fix:* Check model syntax
  ** *Fix:* Verify Jinja2 template variables

=== Authentication Issues with dbt

*Symptoms:*

----
Authentication failed for user
----

*Solutions:*

. *For password authentication:*
+
[source,bash]
----
# Update .env file
DBT_SNOWFLAKE_PASSWORD=<your-PAT-token>
----

. *For key-pair authentication:*
+
[source,bash]
----
# Verify private key exists
ls -la <path-to-private-key>

# Verify public key is set on user
SHOW USERS LIKE '<your-user>';
----

. *Regenerate credentials if needed*

== Streamlit Dashboard Issues

=== Cannot Access Dashboard

*Symptoms:*

* Dashboard URL returns 404
* "Streamlit app not found" error

*Solutions:*

. *Verify app was deployed:*
+
[source,sql]
----
SHOW STREAMLIT IN ACCOUNT;
----

. *Check app status:*
+
[source,sql]
----
DESCRIBE STREAMLIT incident_management_dashboard;
----

. *Redeploy if necessary:*
+
[source,bash]
----
make deploy-streamlit CONN=<your-connection-name>
----

=== Dashboard Shows No Data

*Symptoms:*

* Dashboard loads but tables are empty
* Metrics show zero

*Solutions:*

. *Check data exists in tables:*
+
[source,sql]
----
SELECT COUNT(*) FROM gold_zone.active_incidents;
SELECT COUNT(*) FROM gold_zone.incidents;
----

. *Verify dbt models ran successfully:*
+
[source,sql]
----
SELECT * FROM gold_zone.incidents LIMIT 5;
----

. *Re-run dbt if needed:*
+
[source,bash]
----
make run-dbt CONN=<your-connection-name>
----

=== Attachment Images Not Displaying

*Symptoms:*

* Attachment icon appears but image won't load
* Error when clicking on attachment

*Solutions:*

. *Verify file exists in Snowflake:*
+
[source,sql]
----
SELECT incident_id, attachment_file 
FROM gold_zone.incident_attachments 
WHERE attachment_file IS NOT NULL;
----

. *Check file permissions:*
   ** Ensure Streamlit app role has read access to stage
   ** Verify External Access Integration if loading from URL

== Data Processing Issues

=== AI Classification Not Working

*Symptoms:*

* `category` column is NULL or always "other"
* AI functions return errors

*Diagnostics:*

. *Check Cortex AI availability:*
+
[source,sql]
----
-- Try a simple classification
SELECT ai_classify('This is a test', ['category1', 'category2']);
----

. *Verify function syntax:*
+
[source,sql]
----
-- Check incidents model
SELECT * FROM gold_zone.incidents LIMIT 1;
----

*Solutions:*

* *Issue:* Cortex AI not available in region
  ** *Fix:* Check link:https://docs.snowflake.com/en/user-guide/snowflake-cortex/llm-functions#availability[Cortex AI availability]
  ** *Fix:* Use a supported region

* *Issue:* Insufficient privileges
  ** *Fix:* Grant required permissions:
+
[source,sql]
----
GRANT USAGE ON CORTEX TO ROLE dbt_projects_engineer;
----

* *Issue:* Invalid categories list
  ** *Fix:* Verify `incident_categories` variable in `dbt_project.yml`

=== Incident IDs Not Generating

*Symptoms:*

* `incident_id` is NULL
* Duplicate incident IDs

*Solution:*

Check the ID generation logic in `incidents.sql`:

[source,sql]
----
SELECT 
  'INC-' || YEAR(created_at) || '-' || 
  LPAD(ROW_NUMBER() OVER (ORDER BY created_at), 4, '0') as incident_id
FROM ...
----

Ensure `created_at` timestamp exists and is valid.

=== Incremental Models Not Processing New Data

*Symptoms:*

* New Slack messages don't create new incidents
* Data appears stale

*Solutions:*

. *Check incremental strategy:*
+
[source,sql]
----
-- Should have is_incremental() logic
----

. *Force full refresh:*
+
[source,bash]
----
snow dbt run --full-refresh
----

. *Verify source freshness:*
+
[source,bash]
----
snow dbt source freshness
----

== Performance Issues

=== dbt Runs Taking Too Long

*Symptoms:*

* Transformations take minutes instead of seconds
* Warehouse running at capacity

*Solutions:*

. *Check warehouse size:*
+
[source,sql]
----
SHOW WAREHOUSES LIKE 'v1_demo_wh';
----

. *Increase warehouse size temporarily:*
+
[source,sql]
----
ALTER WAREHOUSE v1_demo_wh SET WAREHOUSE_SIZE = 'MEDIUM';
----

. *Review query plans:*
+
[source,sql]
----
-- Check for full table scans
EXPLAIN SELECT * FROM gold_zone.incidents;
----

. *Optimize incremental models:*
   ** Ensure proper partitioning
   ** Use appropriate incremental strategy
   ** Add clustering keys if needed

=== Dashboard Loading Slowly

*Symptoms:*

* Streamlit app takes long to load
* Queries timing out

*Solutions:*

. *Create materialized views for dashboard queries:*
+
[source,sql]
----
-- Instead of querying heavy tables repeatedly
CREATE VIEW dashboard_summary AS
SELECT ...
----

. *Add filters to limit data:*
   ** Filter to recent incidents only
   ** Limit attachment loading

. *Review query performance:*
+
[source,sql]
----
SELECT * 
FROM TABLE(INFORMATION_SCHEMA.QUERY_HISTORY())
WHERE query_text LIKE '%active_incidents%'
ORDER BY start_time DESC
LIMIT 10;
----

== Getting Additional Help

=== Enable Debug Logging

For more detailed error messages:

[source,bash]
----
# For dbt
snow dbt run --debug --log-level debug

# For Snowflake CLI
snow --debug <command>
----

=== Check System Logs

. *dbt logs:*
+
[source,bash]
----
cat src/incident_management/logs/dbt.log
----

. *Snowflake query history:*
+
[source,sql]
----
SELECT *
FROM TABLE(INFORMATION_SCHEMA.QUERY_HISTORY())
WHERE start_time > DATEADD(hour, -1, CURRENT_TIMESTAMP())
ORDER BY start_time DESC;
----

. *OpenFlow runtime logs:*
   ** Navigate to OpenFlow runtime in Snowsight
   ** Check container logs

=== Contact Support

If issues persist after trying these solutions:

. *Gather diagnostic information:*
   ** Error messages (full text)
   ** Steps to reproduce
   ** Environment details (Snowflake region, account type)
   ** Relevant log excerpts

. *Create GitHub issue:*
   ** Include diagnostic information
   ** Tag with appropriate label
   ** Describe expected vs. actual behavior

. *Email support:*
   ** Send details to: chinmayee.lakkad@snowflake.com

== Useful Commands Reference

[source,bash]
----
# Verify prerequisites
make check-prereqs

# Test Snowflake connection
snow connection test --connection <name>

# Check dbt project structure
snow dbt debug

# Run specific model
snow dbt run --select <model_name>

# View dbt documentation
snow dbt docs generate
snow dbt docs serve

# Full refresh all models
snow dbt run --full-refresh

# Run tests
snow dbt test
----

== Additional Resources

* link:https://docs.snowflake.com/[Snowflake Documentation]
* link:https://docs.getdbt.com/[dbt Documentation]
* link:https://docs.snowflake.com/en/user-guide/data-integration/openflow[OpenFlow Documentation]
* link:https://github.com/Snowflake-Labs/unified-data-stack-for-incident-management/issues[Project GitHub Issues]

