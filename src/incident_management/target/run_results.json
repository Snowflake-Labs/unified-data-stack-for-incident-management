{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.9.4", "generated_at": "2025-11-11T01:05:58.552002Z", "invocation_id": "d86dc2c3-6f8e-4569-b4a7-a16a74a7b82c", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-11T01:05:32.638773Z", "completed_at": "2025-11-11T01:05:32.658995Z"}, {"name": "execute", "started_at": "2025-11-11T01:05:32.659660Z", "completed_at": "2025-11-11T01:05:45.524411Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 12.887181997299194, "adapter_response": {"_message": "SUCCESS 2", "code": "SUCCESS", "rows_affected": 2, "query_id": "01c04f21-0106-f8b0-0032-31870556b31a"}, "message": "SUCCESS 2", "failures": null, "unique_id": "model.incident_management.incidents", "compiled": true, "compiled_code": "-- Create only new incidents in this incremental mode; new incidents are detected by absence of an incident number from previous step in the pipeline or,\n-- they are not related to any existing incident by title and text.\n\n\n-- Get recent open incidents for lookback when incident_code is null\nwith \n\nrecent_open_incidents as (\n    select * from v1_incident_management.gold_zone.incidents\n    where lower(status) = 'open' \n    and reportee_id is not null\n    and created_at > dateadd('day', -7, current_timestamp())\n)\n\n, new_slack_messages as (\n    select lh.*\n    from v1_incident_management.bronze_zone.v_qualify_slack_messages lh \n    left join recent_open_incidents rh \n    on lh.slack_message_id = rh.slack_message_id\n    where rh.slack_message_id is null\n)\n\n-- Split messages based on whether they have valid incident codes\n, messages_with_incident_code as (\n    select *\n    from new_slack_messages\n    where not IS_NULL_VALUE(parse_json(incident_number):incident_code)\n)\n\n, messages_without_incident_code as (\n    select *\n    from new_slack_messages\n    where IS_NULL_VALUE(parse_json(incident_number):incident_code)\n)\n\n-- For messages without incident codes, try to find existing incidents\n, messages_with_matching_incidents as (\n    select \n        sm.*,\n        ai_classify(sm.text, ['payment gateway error', 'login error', 'other']):labels[0] as text_category,\n        roi.incident_number as existing_incident_number\n    from messages_without_incident_code sm\n    left join recent_open_incidents roi \n    on sm.channel = roi.external_source_id \n    and sm.username = roi.reportee_id \n    and ai_filter(\n     prompt('The text category {0} is logically relatable to this record\\'s category {1}', text_category, roi.category)\n    )\n)\n\n-- Combine all messages with their appropriate incident numbers\n, all_processed_messages as (\n    -- Messages that already have incident codes\n    select *, incident_number as final_incident_number\n    from messages_with_incident_code\n    \n    union\n    \n    -- Messages without incident codes, use existing if found, otherwise generate new\n    select \n        * exclude (existing_incident_number, text_category),\n        coalesce(existing_incident_number, concat_ws('-', 'INC', '2025', randstr(3, random()))) as final_incident_number\n    from messages_with_matching_incidents\n)\n\n, enriched_incidents as (\n    select\n        -- Core incident fields matching DDL schema\n        case \n            when not IS_NULL_VALUE(parse_json(sri.incident_number):incident_code) then \n                parse_json(sri.incident_number):incident_code::string\n            else sri.final_incident_number\n        end as incident_number,        \n        \n        -- Image or Text Classification\n        case \n            when sri.attachment_file is not null then \n                ai_classify(sri.attachment_file, ['payment gateway error', 'login error', 'other']):labels[0]\n            else ai_classify(sri.text, ['payment gateway error', 'login error', 'other']):labels[0]\n        end as category,\n        ai_classify(sri.text, ['payment gateway error', 'login error', 'other']):labels[0] as title, \n        case \n            when category = 'payment gateway error' then 'critical'\n            when category = 'login error' then 'high'\n            else 'low'\n        end as priority,\n        \n        -- Status tracking\n        'open' as status,\n        \n        -- People involved\n        '' as assignee_id,\n        sri.reporter_id as reportee_id,\n        \n        -- Timestamps\n        sri.ts as created_at,\n        null as closed_at,\n        sri.ts as updated_at,\n        \n        -- System fields\n        'Slack' as source_system,\n        sri.channel as external_source_id,\n        sri.hasfiles as has_attachments,\n        sri.slack_message_id,\n        \n        -- Latest comment\n        sri.text as last_comment\n\n        \n    from all_processed_messages sri\n)\n\nselect * \nfrom enriched_incidents", "relation_name": "v1_incident_management.gold_zone.incidents", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-11T01:05:45.532995Z", "completed_at": "2025-11-11T01:05:45.547008Z"}, {"name": "execute", "started_at": "2025-11-11T01:05:45.547608Z", "completed_at": "2025-11-11T01:05:47.931321Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 2.3997230529785156, "adapter_response": {"_message": "SUCCESS 1", "code": "SUCCESS", "rows_affected": 1, "query_id": "01c04f21-0106-f8b0-0032-31870556b34a"}, "message": "SUCCESS 1", "failures": null, "unique_id": "model.incident_management.active_incidents", "compiled": true, "compiled_code": "\n\nSELECT \n    i.incident_number,\n    i.title,\n    i.category,\n    i.priority,\n    i.status,\n    i.assignee_id,\n    CONCAT(assignee.first_name, ' ', assignee.last_name) AS assignee_name,\n    i.reportee_id,\n    CONCAT(reportee.first_name, ' ', reportee.last_name) AS reportee_name,\n    i.created_at,\n    i.updated_at,\n    DATEDIFF('hour', i.created_at, CURRENT_TIMESTAMP()) AS age_hours,\n    i.source_system,\n    i.external_source_id,\n    i.has_attachments\nFROM v1_incident_management.gold_zone.incidents i\nLEFT JOIN v1_incident_management.bronze_zone.users assignee ON i.assignee_id = assignee.id\nLEFT JOIN v1_incident_management.bronze_zone.users reportee ON i.reportee_id = reportee.id\nWHERE i.status = 'open'", "relation_name": "v1_incident_management.gold_zone.active_incidents", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-11T01:05:47.936728Z", "completed_at": "2025-11-11T01:05:47.950268Z"}, {"name": "execute", "started_at": "2025-11-11T01:05:47.950971Z", "completed_at": "2025-11-11T01:05:49.977875Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 2.042479991912842, "adapter_response": {"_message": "SUCCESS 1", "code": "SUCCESS", "rows_affected": 1, "query_id": "01c04f21-0106-f8b0-0032-31870556b36e"}, "message": "SUCCESS 1", "failures": null, "unique_id": "model.incident_management.closed_incidents", "compiled": true, "compiled_code": "\n\nSELECT \n    i.incident_number,\n    i.title,\n    i.category,\n    i.priority,\n    i.status,\n    i.assignee_id,\n    i.reportee_id,\n    \n    -- Timeline fields (only available DDL fields)\n    i.created_at,\n    i.closed_at,\n    i.updated_at,\n    \n    -- System information\n    i.source_system,\n    i.external_source_id,\n    i.has_attachments,\n    \n    -- Resolution metrics (simplified)\n    DATEDIFF('minute', i.created_at, i.closed_at) / 60.0 AS total_resolution_hours,\n    \n    -- Month/Year for trending\n    DATE_TRUNC('month', i.closed_at) AS closed_month,\n    EXTRACT(year FROM i.closed_at) AS closed_year,\n    EXTRACT(quarter FROM i.closed_at) AS closed_quarter\n\nFROM v1_incident_management.gold_zone.incidents i\nWHERE LOWER(i.status) IN ('closed', 'resolved') AND i.closed_at IS NOT NULL", "relation_name": "v1_incident_management.gold_zone.closed_incidents", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-11T01:05:49.983161Z", "completed_at": "2025-11-11T01:05:49.996998Z"}, {"name": "execute", "started_at": "2025-11-11T01:05:49.997623Z", "completed_at": "2025-11-11T01:05:52.266627Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 2.2848141193389893, "adapter_response": {"_message": "SUCCESS 0", "code": "SUCCESS", "rows_affected": 0, "query_id": "01c04f21-0106-f8b0-0032-31870556b3a2"}, "message": "SUCCESS 0", "failures": null, "unique_id": "model.incident_management.incident_attachments", "compiled": true, "compiled_code": "\n\nselect \n    dm.file_id as id,\n    i.incident_number,\n    to_file('@INCIDENT_MANAGEMENT.bronze_zone.DOCUMENTS', dm.staged_file_path) as attachment_file,\n    dm.event_ts as uploaded_at\nfrom v1_incident_management.gold_zone.incidents i\ninner join v1_incident_management.bronze_zone.doc_metadata dm \non i.has_attachments \nand i.reportee_id = dm.user_id \nand i.external_source_id = dm.channel_id\nand i.created_at = dm.event_ts", "relation_name": "v1_incident_management.gold_zone.incident_attachments", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-11T01:05:52.271994Z", "completed_at": "2025-11-11T01:05:52.289280Z"}, {"name": "execute", "started_at": "2025-11-11T01:05:52.289879Z", "completed_at": "2025-11-11T01:05:56.280974Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 4.01029634475708, "adapter_response": {"_message": "SUCCESS 2", "code": "SUCCESS", "rows_affected": 2, "query_id": "01c04f21-0106-f8b0-0032-31870556b3e6"}, "message": "SUCCESS 2", "failures": null, "unique_id": "model.incident_management.incident_comment_history", "compiled": true, "compiled_code": "\n\nselect \n    slack_message_id as id,\n    i.incident_number,\n    i.reportee_id as author_id,\n    i.last_comment as content,\n    current_timestamp() as created_at\nfrom v1_incident_management.gold_zone.incidents i\n\n\nwhere i.updated_at > (select coalesce(max(created_at), dateadd('day', -1, current_timestamp())) from v1_incident_management.gold_zone.incident_comment_history)\nand i.updated_at >= dateadd('day', -1, current_timestamp())\nand i.status = 'open'\n", "relation_name": "v1_incident_management.gold_zone.incident_comment_history", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-11T01:05:56.286391Z", "completed_at": "2025-11-11T01:05:56.298257Z"}, {"name": "execute", "started_at": "2025-11-11T01:05:56.298895Z", "completed_at": "2025-11-11T01:05:58.544762Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 2.2597343921661377, "adapter_response": {"_message": "SUCCESS 1", "code": "SUCCESS", "rows_affected": 1, "query_id": "01c04f21-0106-f8b0-0032-31870556b40e"}, "message": "SUCCESS 1", "failures": null, "unique_id": "model.incident_management.weekly_incident_trends", "compiled": true, "compiled_code": "\n\nSELECT \n    DATE_TRUNC('week', created_at) AS week,\n    COUNT(*) AS total_incidents,\n    COUNT(CASE WHEN status = 'resolved' THEN 1 END) AS resolved_incidents,\n    COUNT(CASE WHEN status = 'closed' THEN 1 END) AS closed_incidents,\n    COUNT(CASE WHEN status = 'open' THEN 1 END) AS open_incidents,\n    COUNT(CASE WHEN priority = 'critical' THEN 1 END) AS critical_incidents,\n    COUNT(CASE WHEN priority = 'high' THEN 1 END) AS high_incidents,\n    COUNT(CASE WHEN priority IN ('critical', 'high') THEN 1 END) AS high_severity_incidents,\n    \n    -- Category breakdown\n    COUNT(CASE WHEN category = 'payment' THEN 1 END) AS payment_incidents,\n    COUNT(CASE WHEN category = 'authentication' THEN 1 END) AS authentication_incidents,\n    COUNT(CASE WHEN category = 'performance' THEN 1 END) AS performance_incidents,\n    COUNT(CASE WHEN category = 'security' THEN 1 END) AS security_incidents,\n    \n    -- Source system breakdown\n    COUNT(CASE WHEN source_system = 'monitoring' THEN 1 END) AS monitoring_incidents,\n    COUNT(CASE WHEN source_system = 'customer_portal' THEN 1 END) AS customer_portal_incidents,\n    \n    -- Average resolution time for closed incidents (in hours)\n    AVG(\n        CASE \n            WHEN closed_at IS NOT NULL \n            THEN DATEDIFF('hour', created_at, closed_at)\n            ELSE NULL \n        END\n    ) AS avg_resolution_time_hours,\n    \n    -- Incidents with attachments\n    COUNT(CASE WHEN has_attachments = true THEN 1 END) AS incidents_with_attachments,\n    \n    -- Resolution rate percentage\n    ROUND(\n        (COUNT(CASE WHEN status IN ('resolved', 'closed') THEN 1 END)::DECIMAL / COUNT(*)) * 100, 2\n    ) AS resolution_rate_percentage\nFROM v1_incident_management.gold_zone.incidents\nWHERE created_at >= DATEADD('year', -1, CURRENT_DATE())\nGROUP BY DATE_TRUNC('week', created_at)\nORDER BY week DESC", "relation_name": "v1_incident_management.gold_zone.weekly_incident_trends", "batch_results": null}], "elapsed_time": 29.70490336418152, "args": {"introspect": true, "vars": {}, "log_file_max_bytes": 10485760, "cache_selected_only": false, "profiles_dir": "/tmp/dbt/", "favor_state": false, "log_format_file": "debug", "target_path": "/tmp/dbt/target/", "version_check": true, "print": true, "project_dir": "/tmp/dbt", "static_parser": true, "log_level_file": "debug", "defer": false, "state_modified_compare_vars": false, "macro_debugging": false, "require_resource_names_without_spaces": false, "show_resource_report": false, "use_colors": true, "use_colors_file": true, "send_anonymous_usage_stats": false, "partial_parse": true, "invocation_command": "dbt ", "empty": false, "indirect_selection": "eager", "quiet": false, "populate_cache": true, "exclude": [], "log_path": "/tmp/dbt/logs", "source_freshness_run_project_hooks": false, "printer_width": 80, "log_level": "info", "require_yaml_configuration_for_mf_time_spines": false, "skip_nodes_if_on_run_start_fails": false, "warn_error_options": {"include": [], "exclude": []}, "which": "run", "require_nested_cumulative_type_params": false, "partial_parse_file_diff": true, "strict_mode": false, "write_json": true, "require_explicit_package_overrides_for_builtin_materializations": true, "select": ["gold_zone"], "state_modified_compare_more_unrendered_values": false, "target": "dev", "log_format": "default", "require_batched_execution_for_custom_microbatch_strategy": false}}