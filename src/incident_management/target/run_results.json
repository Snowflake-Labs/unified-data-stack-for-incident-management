{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.9.4", "generated_at": "2025-11-04T23:27:55.652850Z", "invocation_id": "76e05c14-c406-42de-a49e-bb106a69b500", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.061645Z", "completed_at": "2025-11-04T23:27:55.082133Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.082781Z", "completed_at": "2025-11-04T23:27:55.082802Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.022653818130493164, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.incident_management.users", "compiled": true, "compiled_code": "\n\nselect \n    sm.MEMBERIDS[0] as id,\n    sm.memberemails[0] as email,\n    split(sm.memberemails[0], '@')[0] as first_name,\n    split(sm.memberemails[0], '@')[1] as last_name,\n    'reporter' as role,\n    '' as department,\n    '' as team,\n    true as is_active,\n    current_timestamp() as created_at,\n    current_timestamp() as updated_at\nfrom incident_management.bronze_zone.slack_members sm", "relation_name": "incident_management.bronze_zone.users", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.086522Z", "completed_at": "2025-11-04T23:27:55.099003Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.099629Z", "completed_at": "2025-11-04T23:27:55.099645Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.014571428298950195, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.incident_management.v_qualify_new_documents", "compiled": true, "compiled_code": "\n\nselect\n   *,\n    case \n        when contains(relative_path, 'qa') then 'question'\n        when contains(relative_path, 'full') then 'full'\n        else 'full'\n    end as analysis_type\nfrom incident_management.bronze_zone.documents_stream\nWHERE relative_path is not null\nand contains(relative_path, 'pdf|docx|doc|txt|text|html|md|pptx|ppt|png|eml|jpg|jpeg|gif|bmp|tiff|tif|webp|htm')\nand size > 0", "relation_name": "incident_management.bronze_zone.v_qualify_new_documents", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.103753Z", "completed_at": "2025-11-04T23:27:55.118623Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.119267Z", "completed_at": "2025-11-04T23:27:55.119282Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.017408132553100586, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.incident_management.v_qualify_slack_messages", "compiled": true, "compiled_code": "\n\n-- Only propagate messages from known reporters (users in channel)\nwith slack_messages_from_known_reporters as (\n    select sm.*, r.id as reporter_id\n    from incident_management.bronze_zone.slack_messages sm\n    inner join incident_management.bronze_zone.users r on sm.username = split(r.email, '@')[0]\n    where sm.clientmsgid is not null\n    and to_date(sm.ingestts) >= to_date(current_timestamp())\n)\n\n-- Messages with attachments (with join to doc_metadata)\nselect \n    true as hasfiles,\n    sm.type,\n    sm.subtype,\n    sm.team,\n    sm.channel,\n    sm.user,\n    sm.username,\n    sm.reporter_id,\n    sm.text,\n    sm.ts,\n    sm.clientmsgid as slack_message_id,\n    \n    -- Attachment metadata from doc_metadata\n    dm.file_id,\n    dm.file_name, \n    dm.file_mimetype, \n    dm.file_size, \n    dm.staged_file_path,\n    to_file('@INCIDENT_MANAGEMENT.bronze_zone.DOCUMENTS', dm.staged_file_path) as attachment_file,\n    case \n        -- When there is an attachment file and it is an image, use the image to extract the incident code\n        when dm.staged_file_path is not null and fl_is_image(to_file('@INCIDENT_MANAGEMENT.bronze_zone.DOCUMENTS', dm.staged_file_path)) then \n        ai_complete('claude-3-5-sonnet',\n            prompt(\n            $$\n            Find the incident number that may be present either in the image {0} or in the text {1}. \n            Use the one in the image if found.Look for alphanumeric codes preceded by the keyword 'incident' (case-insensitive). \n            Examples: INC-12345, incident_001, INC-2025-001.\n            Respond only in JSON format with a single key called 'incident_code'.\n            Do not add any explanation in the response.\n            $$, \n            attachment_file,\n            text\n            )\n        )\n        else null\n    end as incident_number\n\nfrom slack_messages_from_known_reporters sm\ninner join incident_management.bronze_zone.doc_metadata dm \non (sm.hasfiles and (sm.channel = dm.channel_id) and (sm.ts = dm.event_ts))\n\nUNION ALL\n\n-- Messages without attachments (no join to doc_metadata)\nselect \n    false as hasfiles,\n    sm.type,\n    sm.subtype,\n    sm.team,\n    sm.channel,\n    sm.user,\n    sm.username,\n    sm.reporter_id,\n    sm.text,\n    sm.ts,\n    sm.clientmsgid as slack_message_id,\n    \n    -- No attachment metadata for messages without files\n    null as file_id,\n    null as file_name, \n    null as file_mimetype, \n    null as file_size, \n    null as staged_file_path,\n    null as attachment_file,\n    case \n        -- Only use text to extract the incident code since there are no attachments\n        when sm.text is not null then ai_complete('claude-3-5-sonnet',\n                prompt(\n                $$\n                Extract incident codes from Slack text {0}. \n                Look for alphanumeric codes preceded by the keyword 'incident' (case-insensitive). \n                Examples: INC-12345, incident_001, INC-2025-001.\n                Respond only in JSON format with a single key called 'incident_code'.\n                Do not add any explanation in the response.\n                $$, \n                text\n            )\n        )\n        else null\n    end as incident_number\n\nfrom slack_messages_from_known_reporters sm\nwhere not sm.hasfiles or sm.hasfiles is null", "relation_name": "incident_management.bronze_zone.v_qualify_slack_messages", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.123241Z", "completed_at": "2025-11-04T23:27:55.142239Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.142892Z", "completed_at": "2025-11-04T23:27:55.142910Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.021116018295288086, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.incident_management.source_not_null_bronze_zone_doc_metadata_channel_id.c215ee3d7c", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect channel_id\nfrom incident_management.bronze_zone.doc_metadata\nwhere channel_id is null\n\n\n", "relation_name": null, "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.146500Z", "completed_at": "2025-11-04T23:27:55.161215Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.161837Z", "completed_at": "2025-11-04T23:27:55.161851Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.01676774024963379, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.incident_management.source_not_null_bronze_zone_doc_metadata_event_ts.8b545f1d7b", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect event_ts\nfrom incident_management.bronze_zone.doc_metadata\nwhere event_ts is null\n\n\n", "relation_name": null, "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.165344Z", "completed_at": "2025-11-04T23:27:55.178197Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.178920Z", "completed_at": "2025-11-04T23:27:55.178933Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.014956235885620117, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.incident_management.source_not_null_bronze_zone_doc_metadata_file_id.b8ec34c9b2", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect file_id\nfrom incident_management.bronze_zone.doc_metadata\nwhere file_id is null\n\n\n", "relation_name": null, "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.182385Z", "completed_at": "2025-11-04T23:27:55.195191Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.195798Z", "completed_at": "2025-11-04T23:27:55.195810Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.014826297760009766, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.incident_management.source_not_null_bronze_zone_file_hashes_hash_value.af662aaabc", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect hash_value\nfrom incident_management.bronze_zone.file_hashes\nwhere hash_value is null\n\n\n", "relation_name": null, "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.199258Z", "completed_at": "2025-11-04T23:27:55.213528Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.214149Z", "completed_at": "2025-11-04T23:27:55.214163Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.01636362075805664, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.incident_management.source_not_null_bronze_zone_slack_members_conversationid.425c949d44", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect conversationid\nfrom incident_management.bronze_zone.slack_members\nwhere conversationid is null\n\n\n", "relation_name": null, "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.217517Z", "completed_at": "2025-11-04T23:27:55.229771Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.230397Z", "completed_at": "2025-11-04T23:27:55.230406Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.014242172241210938, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.incident_management.source_not_null_bronze_zone_slack_members_lastupdated.3f8dd11efc", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect lastupdated\nfrom incident_management.bronze_zone.slack_members\nwhere lastupdated is null\n\n\n", "relation_name": null, "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.233676Z", "completed_at": "2025-11-04T23:27:55.247492Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.248087Z", "completed_at": "2025-11-04T23:27:55.248095Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.015742778778076172, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.incident_management.source_not_null_bronze_zone_slack_messages_ts.472b618185", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect ts\nfrom incident_management.bronze_zone.slack_messages\nwhere ts is null\n\n\n", "relation_name": null, "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.251430Z", "completed_at": "2025-11-04T23:27:55.263984Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.264573Z", "completed_at": "2025-11-04T23:27:55.264582Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.014480352401733398, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.incident_management.source_not_null_bronze_zone_users_created_at.1978bf3b23", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect created_at\nfrom incident_management.bronze_zone.users\nwhere created_at is null\n\n\n", "relation_name": null, "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.267831Z", "completed_at": "2025-11-04T23:27:55.281574Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.282186Z", "completed_at": "2025-11-04T23:27:55.282195Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.015674352645874023, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.incident_management.source_not_null_bronze_zone_users_email.36447ce580", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect email\nfrom incident_management.bronze_zone.users\nwhere email is null\n\n\n", "relation_name": null, "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.285418Z", "completed_at": "2025-11-04T23:27:55.297665Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.298268Z", "completed_at": "2025-11-04T23:27:55.298278Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.014210700988769531, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.incident_management.source_not_null_bronze_zone_users_id.88848c2ec8", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect id\nfrom incident_management.bronze_zone.users\nwhere id is null\n\n\n", "relation_name": null, "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.301627Z", "completed_at": "2025-11-04T23:27:55.316964Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.317553Z", "completed_at": "2025-11-04T23:27:55.317561Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.017274856567382812, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.incident_management.source_unique_bronze_zone_users_email.fec1fcf20d", "compiled": true, "compiled_code": "\n    \n    \n\nselect\n    email as unique_field,\n    count(*) as n_records\n\nfrom incident_management.bronze_zone.users\nwhere email is not null\ngroup by email\nhaving count(*) > 1\n\n\n", "relation_name": null, "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.323054Z", "completed_at": "2025-11-04T23:27:55.334721Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.335380Z", "completed_at": "2025-11-04T23:27:55.335394Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.013731002807617188, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.incident_management.document_full_extracts", "compiled": true, "compiled_code": "\n\n\nwith document_all_pages\nas\n(\n    select\n        *,\n        AI_PARSE_DOCUMENT (\n            TO_FILE('@INCIDENT_MANAGEMENT.bronze_zone.DOCUMENTS/full',relative_path),\n            parse_mode => 'LAYOUT', \n            page_split => true\n        ) as chunk\n        FROM incident_management.bronze_zone.v_qualify_new_documents\n        WHERE analysis_type = 'full'\n)\n\nselect \n*,\nf.value:content::STRING as page_content,\nf.index::int as page_num\nfrom document_all_pages,\nLATERAL FLATTEN(input => chunk:pages) f;", "relation_name": "incident_management.bronze_zone.document_full_extracts", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.339194Z", "completed_at": "2025-11-04T23:27:55.372882Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.373514Z", "completed_at": "2025-11-04T23:27:55.373523Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.03588509559631348, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.incident_management.document_question_extracts", "compiled": true, "compiled_code": "import snowflake.snowpark.functions as F\nfrom snowflake.snowpark import Session\nimport json\n\ndef get_response_format(relative_path: str):\n    asset_path = dbt.config.get(\"asset_path\")\n    with open(f'{asset_path}/{relative_path}.json', 'r') as f:\n        response_format = json.load(f)\n    return response_format\n\ndef model(dbt, session: Session):\n    dbt.config(\n        materialized='table',\n        description='Table to store question extracts from documents'\n    )\n    \n    # Get the upstream model\n    v_qualify_new_documents = dbt.ref('v_qualify_new_documents')\n    \n    # Filter for question analysis type\n    document_all_pages = v_qualify_new_documents.filter(\n        F.col('analysis_type') == 'question'\n    )\n    \n    # Add AI_EXTRACT column\n    # Note: AI_EXTRACT with TO_FILE and response_format needs to be done via SQL expression\n    document_all_pages = document_all_pages.with_column(\n        'question_extracts_json',\n        F.call_builtin(\n            'AI_EXTRACT',\n            F.call_builtin('TO_FILE', F.lit(f'{dbt.config.get(\"docs_stage_path\")}/qa'), F.col('relative_path')),\n            get_response_format(F.col('relative_path'))\n        )\n    )\n    \n    return document_all_pages\n\n\n# This part is user provided model code\n# you will need to copy the next section to run the code\n# COMMAND ----------\n# this part is dbt logic for get ref work, do not modify\n\ndef ref(*args, **kwargs):\n    refs = {\"v_qualify_new_documents\": \"incident_management.bronze_zone.v_qualify_new_documents\"}\n    key = '.'.join(args)\n    version = kwargs.get(\"v\") or kwargs.get(\"version\")\n    if version:\n        key += f\".v{version}\"\n    dbt_load_df_function = kwargs.get(\"dbt_load_df_function\")\n    return dbt_load_df_function(refs[key])\n\n\ndef source(*args, dbt_load_df_function):\n    sources = {}\n    key = '.'.join(args)\n    return dbt_load_df_function(sources[key])\n\n\nconfig_dict = {'asset_path': None, 'docs_stage_path': None}\n\n\nclass config:\n    def __init__(self, *args, **kwargs):\n        pass\n\n    @staticmethod\n    def get(key, default=None):\n        return config_dict.get(key, default)\n\nclass this:\n    \"\"\"dbt.this() or dbt.this.identifier\"\"\"\n    database = \"incident_management\"\n    schema = \"bronze_zone\"\n    identifier = \"document_question_extracts\"\n    \n    def __repr__(self):\n        return 'incident_management.bronze_zone.document_question_extracts'\n\n\nclass dbtObj:\n    def __init__(self, load_df_function) -> None:\n        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)\n        self.ref = lambda *args, **kwargs: ref(*args, **kwargs, dbt_load_df_function=load_df_function)\n        self.config = config\n        self.this = this()\n        self.is_incremental = False\n\n# COMMAND ----------\n\n\n", "relation_name": "incident_management.bronze_zone.document_question_extracts", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.377029Z", "completed_at": "2025-11-04T23:27:55.392085Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.392710Z", "completed_at": "2025-11-04T23:27:55.392719Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.017063379287719727, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.incident_management.incidents", "compiled": true, "compiled_code": "-- Create only new incidents in this incremental mode; new incidents are detected by absence of an incident number from previous step in the pipeline or,\n-- they are not related to any existing incident by title and text.\n\n\n-- Get recent open incidents for lookback when incident_code is null\nwith \n\nrecent_open_incidents as (\n    select * from incident_management.gold_zone.incidents\n    where lower(status) = 'open' \n    and reportee_id is not null\n    and created_at > dateadd('day', -7, current_timestamp())\n)\n\n, new_slack_messages as (\n    select lh.*\n    from incident_management.bronze_zone.v_qualify_slack_messages lh \n    left join recent_open_incidents rh \n    on lh.slack_message_id = rh.slack_message_id\n    where rh.slack_message_id is null\n)\n\n-- Split messages based on whether they have valid incident codes\n, messages_with_incident_code as (\n    select *\n    from new_slack_messages\n    where not IS_NULL_VALUE(parse_json(incident_number):incident_code)\n)\n\n, messages_without_incident_code as (\n    select *\n    from new_slack_messages\n    where IS_NULL_VALUE(parse_json(incident_number):incident_code)\n)\n\n-- For messages without incident codes, try to find existing incidents\n, messages_with_matching_incidents as (\n    select \n        sm.*,\n        ai_classify(sm.text, ['payment gateway error', 'login error', 'other']):labels[0] as text_category,\n        roi.incident_number as existing_incident_number\n    from messages_without_incident_code sm\n    left join recent_open_incidents roi \n    on sm.channel = roi.external_source_id \n    and sm.username = roi.reportee_id \n    and ai_filter(\n     prompt('The text category {0} is logically relatable to this record\\'s category {1}', text_category, roi.category)\n    )\n)\n\n-- Combine all messages with their appropriate incident numbers\n, all_processed_messages as (\n    -- Messages that already have incident codes\n    select *, incident_number as final_incident_number\n    from messages_with_incident_code\n    \n    union\n    \n    -- Messages without incident codes, use existing if found, otherwise generate new\n    select \n        * exclude (existing_incident_number, text_category),\n        coalesce(existing_incident_number, concat_ws('-', 'INC', '2025', randstr(3, random()))) as final_incident_number\n    from messages_with_matching_incidents\n)\n\n, enriched_incidents as (\n    select\n        -- Core incident fields matching DDL schema\n        case \n            when not IS_NULL_VALUE(parse_json(sri.incident_number):incident_code) then \n                parse_json(sri.incident_number):incident_code::string\n            else sri.final_incident_number\n        end as incident_number,        \n        \n        -- Image or Text Classification\n        case \n            when sri.attachment_file is not null then \n                ai_classify(sri.attachment_file, ['payment gateway error', 'login error', 'other']):labels[0]\n            else ai_classify(sri.text, ['payment gateway error', 'login error', 'other']):labels[0]\n        end as category,\n        ai_classify(sri.text, ['payment gateway error', 'login error', 'other']):labels[0] as title, \n        case \n            when category = 'payment gateway error' then 'critical'\n            when category = 'login error' then 'high'\n            else 'low'\n        end as priority,\n        \n        -- Status tracking\n        'open' as status,\n        \n        -- People involved\n        '' as assignee_id,\n        sri.reporter_id as reportee_id,\n        \n        -- Timestamps\n        sri.ts as created_at,\n        null as closed_at,\n        sri.ts as updated_at,\n        \n        -- System fields\n        'Slack' as source_system,\n        sri.channel as external_source_id,\n        sri.hasfiles as has_attachments,\n        sri.slack_message_id,\n        \n        -- Latest comment\n        sri.text as last_comment\n\n        \n    from all_processed_messages sri\n)\n\nselect * \nfrom enriched_incidents", "relation_name": "incident_management.gold_zone.incidents", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.397109Z", "completed_at": "2025-11-04T23:27:55.409346Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.409963Z", "completed_at": "2025-11-04T23:27:55.409972Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.014259815216064453, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.incident_management.active_incidents", "compiled": true, "compiled_code": "\n\nSELECT \n    i.incident_number,\n    i.title,\n    i.category,\n    i.priority,\n    i.status,\n    i.assignee_id,\n    CONCAT(assignee.first_name, ' ', assignee.last_name) AS assignee_name,\n    i.reportee_id,\n    CONCAT(reportee.first_name, ' ', reportee.last_name) AS reportee_name,\n    i.created_at,\n    i.updated_at,\n    DATEDIFF('hour', i.created_at, CURRENT_TIMESTAMP()) AS age_hours,\n    i.source_system,\n    i.external_source_id,\n    i.has_attachments\nFROM incident_management.gold_zone.incidents i\nLEFT JOIN incident_management.bronze_zone.users assignee ON i.assignee_id = assignee.id\nLEFT JOIN incident_management.bronze_zone.users reportee ON i.reportee_id = reportee.id\nWHERE i.status = 'open'", "relation_name": "incident_management.gold_zone.active_incidents", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.413386Z", "completed_at": "2025-11-04T23:27:55.426720Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.427305Z", "completed_at": "2025-11-04T23:27:55.427313Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.015277624130249023, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.incident_management.closed_incidents", "compiled": true, "compiled_code": "\n\nSELECT \n    i.incident_number,\n    i.title,\n    i.category,\n    i.priority,\n    i.status,\n    i.assignee_id,\n    i.reportee_id,\n    \n    -- Timeline fields (only available DDL fields)\n    i.created_at,\n    i.closed_at,\n    i.updated_at,\n    \n    -- System information\n    i.source_system,\n    i.external_source_id,\n    i.has_attachments,\n    \n    -- Resolution metrics (simplified)\n    DATEDIFF('minute', i.created_at, i.closed_at) / 60.0 AS total_resolution_hours,\n    \n    -- Month/Year for trending\n    DATE_TRUNC('month', i.closed_at) AS closed_month,\n    EXTRACT(year FROM i.closed_at) AS closed_year,\n    EXTRACT(quarter FROM i.closed_at) AS closed_quarter\n\nFROM incident_management.gold_zone.incidents i\nWHERE LOWER(i.status) IN ('closed', 'resolved') AND i.closed_at IS NOT NULL", "relation_name": "incident_management.gold_zone.closed_incidents", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.431038Z", "completed_at": "2025-11-04T23:27:55.443873Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.444466Z", "completed_at": "2025-11-04T23:27:55.444475Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.014803647994995117, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.incident_management.incident_attachments", "compiled": true, "compiled_code": "\n\nselect \n    dm.file_id as id,\n    i.incident_number,\n    to_file('@INCIDENT_MANAGEMENT.bronze_zone.DOCUMENTS', dm.staged_file_path) as attachment_file,\n    dm.event_ts as uploaded_at\nfrom incident_management.gold_zone.incidents i\ninner join incident_management.bronze_zone.doc_metadata dm \non i.has_attachments \nand i.reportee_id = dm.user_id \nand i.external_source_id = dm.channel_id\nand i.created_at = dm.event_ts", "relation_name": "incident_management.gold_zone.incident_attachments", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.447848Z", "completed_at": "2025-11-04T23:27:55.462027Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.462654Z", "completed_at": "2025-11-04T23:27:55.462663Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.016148090362548828, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.incident_management.incident_comment_history", "compiled": true, "compiled_code": "\n\nselect \n    slack_message_id as id,\n    i.incident_number,\n    i.reportee_id as author_id,\n    i.last_comment as content,\n    current_timestamp() as created_at\nfrom incident_management.gold_zone.incidents i\n\n", "relation_name": "incident_management.gold_zone.incident_comment_history", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.466105Z", "completed_at": "2025-11-04T23:27:55.478045Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.478769Z", "completed_at": "2025-11-04T23:27:55.478779Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.014041662216186523, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.incident_management.monthly_incident_trends", "compiled": true, "compiled_code": "\n\nSELECT \n    DATE_TRUNC('month', created_at) AS month,\n    COUNT(*) AS total_incidents,\n    COUNT(CASE WHEN status = 'resolved' OR status = 'closed' THEN 1 END) AS closed_incidents,\n    COUNT(CASE WHEN status = 'open' THEN 1 END) AS open_incidents,\n    COUNT(CASE WHEN priority = 'critical' THEN 1 END) AS critical_incidents,\n    COUNT(CASE WHEN priority = 'high' THEN 1 END) AS high_priority_incidents,\n    COUNT(CASE WHEN priority = 'medium' THEN 1 END) AS medium_priority_incidents,\n    COUNT(CASE WHEN priority = 'low' THEN 1 END) AS low_priority_incidents,\n    \n    -- Category breakdown\n    COUNT(CASE WHEN category = 'payment' THEN 1 END) AS payment_incidents,\n    COUNT(CASE WHEN category = 'authentication' THEN 1 END) AS authentication_incidents,\n    COUNT(CASE WHEN category = 'performance' THEN 1 END) AS performance_incidents,\n    COUNT(CASE WHEN category = 'security' THEN 1 END) AS security_incidents,\n    \n    -- Source system breakdown\n    COUNT(CASE WHEN source_system = 'monitoring' THEN 1 END) AS monitoring_incidents,\n    COUNT(CASE WHEN source_system = 'customer_portal' THEN 1 END) AS customer_portal_incidents,\n    COUNT(CASE WHEN source_system = 'manual' THEN 1 END) AS manual_incidents,\n    \n    -- Average resolution time for closed incidents (in hours)\n    AVG(\n        CASE \n            WHEN closed_at IS NOT NULL \n            THEN DATEDIFF('hour', created_at, closed_at)\n            ELSE NULL \n        END\n    ) AS avg_resolution_time_hours,\n    \n    -- Incidents with attachments\n    COUNT(CASE WHEN has_attachments = true THEN 1 END) AS incidents_with_attachments,\n    \n    -- Resolution rate percentage\n    ROUND(\n        (COUNT(CASE WHEN status IN ('resolved', 'closed') THEN 1 END)::DECIMAL / COUNT(*)) * 100, 2\n    ) AS resolution_rate_percentage\n    \nFROM incident_management.gold_zone.incidents\nGROUP BY DATE_TRUNC('month', created_at)\nORDER BY month DESC", "relation_name": "incident_management.gold_zone.monthly_incident_trends", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.482201Z", "completed_at": "2025-11-04T23:27:55.494549Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.495151Z", "completed_at": "2025-11-04T23:27:55.495160Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.014316082000732422, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.incident_management.v_slack_msg_incident_number", "compiled": true, "compiled_code": "\n\nwith \nrecent_recorded_incidents as (\n    select * from incident_management.gold_zone.incidents\n    where status = 'open' and reportee_id is not null\n    and created_at > dateadd('day', -7, current_timestamp())\n), -- match only open incidents from the last 7 days to avoid stale incidents that are past SLA expiry\nincident_number_in_slack_message as (\n    select * from incident_management.bronze_zone.v_qualify_slack_messages\n    where not IS_NULL_VALUE(parse_json(incident_number):incident_code)\n),\nincident_number_not_in_slack_message as (\n    select * from incident_management.bronze_zone.v_qualify_slack_messages\n    where IS_NULL_VALUE(parse_json(incident_number):incident_code)\n)\n\nselect * \nfrom incident_number_in_slack_message sm\n\nunion all\n\nselect \n    sm.* exclude (incident_number),\n    i.incident_number as incident_number\nfrom incident_number_not_in_slack_message sm\nleft join recent_recorded_incidents i \non sm.channel = i.external_source_id  and i.reportee_id =sm.username -- where incident was reported from the same channel and the reportee is the same as the reporter\nand ai_filter(prompt($$\n    Return true if this incident title {0} is refers to the problem now being described in this recent Slack message {1}, else return false.\n    If multiple incidents are related, return true for the most recent incident by created_at timestamp.\n    Only one can be true at a time.\n    Do not add any explanation in the response.\n$$, i.title, sm.text)) -- where the incident title is relatable to the recent Slack message text", "relation_name": "incident_management.bronze_zone.v_slack_msg_incident_number", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.498848Z", "completed_at": "2025-11-04T23:27:55.512419Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.513014Z", "completed_at": "2025-11-04T23:27:55.513023Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.015635251998901367, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.incident_management.weekly_incident_trends", "compiled": true, "compiled_code": "\n\nSELECT \n    DATE_TRUNC('week', created_at) AS week,\n    COUNT(*) AS total_incidents,\n    COUNT(CASE WHEN status = 'resolved' THEN 1 END) AS resolved_incidents,\n    COUNT(CASE WHEN status = 'closed' THEN 1 END) AS closed_incidents,\n    COUNT(CASE WHEN status = 'open' THEN 1 END) AS open_incidents,\n    COUNT(CASE WHEN priority = 'critical' THEN 1 END) AS critical_incidents,\n    COUNT(CASE WHEN priority = 'high' THEN 1 END) AS high_incidents,\n    COUNT(CASE WHEN priority IN ('critical', 'high') THEN 1 END) AS high_severity_incidents,\n    \n    -- Category breakdown\n    COUNT(CASE WHEN category = 'payment' THEN 1 END) AS payment_incidents,\n    COUNT(CASE WHEN category = 'authentication' THEN 1 END) AS authentication_incidents,\n    COUNT(CASE WHEN category = 'performance' THEN 1 END) AS performance_incidents,\n    COUNT(CASE WHEN category = 'security' THEN 1 END) AS security_incidents,\n    \n    -- Source system breakdown\n    COUNT(CASE WHEN source_system = 'monitoring' THEN 1 END) AS monitoring_incidents,\n    COUNT(CASE WHEN source_system = 'customer_portal' THEN 1 END) AS customer_portal_incidents,\n    \n    -- Average resolution time for closed incidents (in hours)\n    AVG(\n        CASE \n            WHEN closed_at IS NOT NULL \n            THEN DATEDIFF('hour', created_at, closed_at)\n            ELSE NULL \n        END\n    ) AS avg_resolution_time_hours,\n    \n    -- Incidents with attachments\n    COUNT(CASE WHEN has_attachments = true THEN 1 END) AS incidents_with_attachments,\n    \n    -- Resolution rate percentage\n    ROUND(\n        (COUNT(CASE WHEN status IN ('resolved', 'closed') THEN 1 END)::DECIMAL / COUNT(*)) * 100, 2\n    ) AS resolution_rate_percentage\nFROM incident_management.gold_zone.incidents\nWHERE created_at >= DATEADD('year', -1, CURRENT_DATE())\nGROUP BY DATE_TRUNC('week', created_at)\nORDER BY week DESC", "relation_name": "incident_management.gold_zone.weekly_incident_trends", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.516538Z", "completed_at": "2025-11-04T23:27:55.529624Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.530252Z", "completed_at": "2025-11-04T23:27:55.530261Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.015124320983886719, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.incident_management.accepted_values_closed_incidents_priority__low__medium__high__critical.663517691c", "compiled": true, "compiled_code": "\n    \n    \n\nwith all_values as (\n\n    select\n        priority as value_field,\n        count(*) as n_records\n\n    from incident_management.gold_zone.closed_incidents\n    group by priority\n\n)\n\nselect *\nfrom all_values\nwhere value_field not in (\n    'low','medium','high','critical'\n)\n\n\n", "relation_name": null, "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.533593Z", "completed_at": "2025-11-04T23:27:55.547344Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.547936Z", "completed_at": "2025-11-04T23:27:55.547944Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.01567244529724121, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.incident_management.accepted_values_closed_incidents_status__closed__resolved.ebedd591a4", "compiled": true, "compiled_code": "\n    \n    \n\nwith all_values as (\n\n    select\n        status as value_field,\n        count(*) as n_records\n\n    from incident_management.gold_zone.closed_incidents\n    group by status\n\n)\n\nselect *\nfrom all_values\nwhere value_field not in (\n    'closed','resolved'\n)\n\n\n", "relation_name": null, "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.551305Z", "completed_at": "2025-11-04T23:27:55.563859Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.564461Z", "completed_at": "2025-11-04T23:27:55.564469Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.014484405517578125, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.incident_management.not_null_closed_incidents_closed_at.ff47a7249a", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect closed_at\nfrom incident_management.gold_zone.closed_incidents\nwhere closed_at is null\n\n\n", "relation_name": null, "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.567835Z", "completed_at": "2025-11-04T23:27:55.581971Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.582591Z", "completed_at": "2025-11-04T23:27:55.582600Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.016086339950561523, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.incident_management.not_null_closed_incidents_created_at.f144a202e9", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect created_at\nfrom incident_management.gold_zone.closed_incidents\nwhere created_at is null\n\n\n", "relation_name": null, "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.585898Z", "completed_at": "2025-11-04T23:27:55.598367Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.599029Z", "completed_at": "2025-11-04T23:27:55.599038Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.014466047286987305, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.incident_management.not_null_closed_incidents_incident_number.f083158543", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect incident_number\nfrom incident_management.gold_zone.closed_incidents\nwhere incident_number is null\n\n\n", "relation_name": null, "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.602330Z", "completed_at": "2025-11-04T23:27:55.614630Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.615217Z", "completed_at": "2025-11-04T23:27:55.615225Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.014220237731933594, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.incident_management.not_null_closed_incidents_title.bf5e3f1d33", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect title\nfrom incident_management.gold_zone.closed_incidents\nwhere title is null\n\n\n", "relation_name": null, "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.618625Z", "completed_at": "2025-11-04T23:27:55.632476Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.633068Z", "completed_at": "2025-11-04T23:27:55.633077Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.01584625244140625, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.incident_management.not_null_closed_incidents_total_resolution_hours.838e65647a", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect total_resolution_hours\nfrom incident_management.gold_zone.closed_incidents\nwhere total_resolution_hours is null\n\n\n", "relation_name": null, "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-11-04T23:27:55.636352Z", "completed_at": "2025-11-04T23:27:55.648291Z"}, {"name": "execute", "started_at": "2025-11-04T23:27:55.648951Z", "completed_at": "2025-11-04T23:27:55.648959Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 0.013906240463256836, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.incident_management.unique_closed_incidents_incident_number.dd9483020e", "compiled": true, "compiled_code": "\n    \n    \n\nselect\n    incident_number as unique_field,\n    count(*) as n_records\n\nfrom incident_management.gold_zone.closed_incidents\nwhere incident_number is not null\ngroup by incident_number\nhaving count(*) > 1\n\n\n", "relation_name": null, "batch_results": null}], "elapsed_time": 3.189758777618408, "args": {"indirect_selection": "eager", "write_json": true, "require_nested_cumulative_type_params": false, "warn_error_options": {"include": [], "exclude": []}, "require_yaml_configuration_for_mf_time_spines": false, "favor_state": false, "static_parser": true, "which": "compile", "strict_mode": false, "partial_parse": true, "state_modified_compare_vars": false, "introspect": true, "select": [], "empty": false, "exclude": [], "quiet": false, "send_anonymous_usage_stats": false, "printer_width": 80, "use_colors_file": true, "require_resource_names_without_spaces": false, "cache_selected_only": false, "require_batched_execution_for_custom_microbatch_strategy": false, "macro_debugging": false, "show_resource_report": false, "output": "text", "project_dir": "/tmp/dbt", "populate_cache": true, "log_path": "/tmp/dbt/logs", "log_format": "default", "log_format_file": "debug", "log_level": "info", "partial_parse_file_diff": true, "source_freshness_run_project_hooks": false, "use_colors": true, "vars": {}, "skip_nodes_if_on_run_start_fails": false, "log_file_max_bytes": 10485760, "defer": false, "target": "dev", "print": true, "profiles_dir": "/tmp/dbt/", "invocation_command": "dbt ", "state_modified_compare_more_unrendered_values": false, "version_check": true, "target_path": "/tmp/dbt/target/", "inject_ephemeral_ctes": true, "log_level_file": "debug", "require_explicit_package_overrides_for_builtin_materializations": true}}